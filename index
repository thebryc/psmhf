<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patricia Saidu Memorial Health Fellows Scholarship · Review Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #C9A84C;
    --gold-light: #E8C96A;
    --gold-dim: #7a6330;
    --bg: #07070e;
    --surface: #0d0d1a;
    --surface2: #111120;
    --border: #1c1c2e;
    --border2: #252538;
    --text: #e8e0cc;
    --text-dim: #8a8098;
    --text-faint: #3a3a52;
    --red: #c0392b;
    --green: #27ae60;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Cormorant Garamond', Georgia, serif;
    min-height: 100vh; font-size: 16px; }
  button { font-family: inherit; cursor: pointer; }
  input, select, textarea { font-family: 'DM Mono', monospace; }

  /* ── Layout ── */
  #app { min-height: 100vh; }
  .screen { display: none; } .screen.active { display: flex; flex-direction: column; min-height: 100vh; }

  /* ── Login ── */
  #login-screen { align-items: center; justify-content: center; background: var(--bg);
    background-image: radial-gradient(ellipse at 20% 50%, rgba(201,168,76,0.04) 0%, transparent 60%),
                      radial-gradient(ellipse at 80% 20%, rgba(201,168,76,0.03) 0%, transparent 50%); }
  .login-box { width: 380px; padding: 48px 40px; background: var(--surface);
    border: 1px solid var(--border2); border-radius: 16px;
    box-shadow: 0 60px 120px rgba(0,0,0,0.8), 0 0 0 1px rgba(201,168,76,0.05); }
  .login-logo { width: 54px; height: 54px; border-radius: 50%;
    background: linear-gradient(135deg, var(--gold), #7a5520);
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 18px; font-size: 24px; color: var(--bg); }
  .login-title { text-align: center; margin-bottom: 36px; }
  .login-title h1 { font-size: 19px; font-weight: 300; line-height: 1.5; color: var(--text); letter-spacing: 0.3px; }
  .login-title p { font-size: 10px; letter-spacing: 1.5px; color: var(--text-faint); margin-top: 8px;
    font-family: 'DM Mono', monospace; text-transform: uppercase; }

  /* ── Form elements ── */
  .field-label { display: block; font-size: 10px; letter-spacing: 1.2px; color: var(--text-dim);
    text-transform: uppercase; font-family: 'DM Mono', monospace; margin-bottom: 7px; }
  .field-input { width: 100%; padding: 11px 13px; background: rgba(255,255,255,0.03);
    border: 1px solid var(--border2); border-radius: 7px; color: var(--text);
    font-size: 13px; outline: none; transition: border-color 0.2s; }
  .field-input:focus { border-color: var(--gold-dim); }
  .field-input.error { border-color: var(--red); }
  .field-group { margin-bottom: 16px; }
  textarea.field-input { resize: vertical; line-height: 1.8; }

  /* ── Buttons ── */
  .btn-primary { padding: 12px 24px; background: linear-gradient(135deg, var(--gold), #a07020);
    border: none; border-radius: 8px; color: var(--bg); font-size: 13px; font-weight: 600;
    letter-spacing: 0.3px; transition: opacity 0.2s; font-family: 'DM Mono', monospace; }
  .btn-primary:hover { opacity: 0.9; }
  .btn-primary:disabled { background: var(--border2); color: var(--text-faint); cursor: not-allowed; opacity: 1; }
  .btn-outline { padding: 9px 18px; background: none; border: 1px solid var(--border2);
    border-radius: 7px; color: var(--text-dim); font-size: 12px; transition: border-color 0.2s;
    font-family: 'DM Mono', monospace; }
  .btn-outline:hover { border-color: var(--gold-dim); color: var(--gold); }
  .btn-ghost { background: none; border: none; color: var(--text-faint); padding: 4px 8px;
    font-size: 12px; transition: color 0.2s; font-family: 'DM Mono', monospace; }
  .btn-ghost:hover { color: var(--red); }
  .btn-icon { background: none; border: none; color: var(--text-faint); padding: 6px;
    display: flex; align-items: center; transition: color 0.2s; }
  .btn-icon:hover { color: var(--text); }

  /* ── Header ── */
  .app-header { height: 54px; background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 28px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .header-left { display: flex; align-items: center; gap: 20px; }
  .header-logo { color: var(--gold); font-size: 18px; line-height: 1; }
  .header-title { color: var(--text-dim); font-size: 13px; font-weight: 300; letter-spacing: 0.3px; }
  .header-user { color: #555; font-size: 11px; font-family: 'DM Mono', monospace; }
  .header-nav { display: flex; gap: 3px; }
  .nav-btn { padding: 6px 14px; border: none; border-radius: 6px; font-size: 11px; letter-spacing: 0.5px;
    text-transform: uppercase; font-family: 'DM Mono', monospace; transition: all 0.15s; }
  .nav-btn.active { background: var(--gold); color: var(--bg); }
  .nav-btn:not(.active) { background: none; color: var(--text-faint); }
  .nav-btn:not(.active):hover { color: var(--text-dim); }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .progress-text { font-size: 11px; color: var(--text-faint); font-family: 'DM Mono', monospace; }

  /* ── Main content ── */
  .main-content { flex: 1; overflow-y: auto; padding: 32px 28px; max-width: 860px; margin: 0 auto; width: 100%; }
  .page-title { font-size: 22px; font-weight: 300; color: var(--text); margin-bottom: 24px; letter-spacing: 0.3px; }
  .page-subtitle { font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 28px; }

  /* ── Cards ── */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 11px; padding: 22px 24px; }
  .card + .card { margin-top: 12px; }
  .card-title { font-size: 11px; letter-spacing: 1.2px; text-transform: uppercase;
    font-family: 'DM Mono', monospace; color: var(--text-dim); margin-bottom: 16px; }

  /* ── Applicant list ── */
  .applicant-row { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px 20px; margin-bottom: 10px; }
  .applicant-row-top { display: flex; justify-content: space-between; align-items: center; }
  .applicant-id { font-size: 15px; color: var(--text); font-weight: 300; }
  .applicant-meta { font-size: 12px; color: var(--text-faint); margin-top: 3px; font-family: 'DM Mono', monospace; }
  .applicant-actions { display: flex; align-items: center; gap: 10px; }
  .avg-badge { font-size: 12px; color: var(--gold); font-family: 'DM Mono', monospace; }
  .btn-edit { padding: 4px 12px; border: 1px solid var(--border2); border-radius: 6px; background: none;
    color: var(--text-dim); font-size: 11px; font-family: 'DM Mono', monospace; transition: all 0.15s; }
  .btn-edit:hover { border-color: var(--gold-dim); color: var(--gold); }
  .link-inputs { display: flex; gap: 10px; margin-top: 12px; }
  .link-input-wrap { flex: 1; }
  .link-badges { display: flex; gap: 8px; margin-top: 10px; }
  .link-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px;
    background: rgba(201,168,76,0.08); border: 1px solid rgba(201,168,76,0.2); border-radius: 6px;
    color: var(--gold); font-size: 11px; font-family: 'DM Mono', monospace; text-decoration: none; }
  .link-badge:hover { background: rgba(201,168,76,0.14); }

  /* ── Import tab ── */
  .drop-zone { border: 2px dashed var(--border2); border-radius: 12px; padding: 48px 28px;
    text-align: center; margin-bottom: 20px; transition: border-color 0.2s; }
  .drop-zone:hover { border-color: var(--gold-dim); }
  .drop-icon { font-size: 32px; margin-bottom: 12px; color: var(--gold); opacity: 0.6; }
  .drop-label { font-size: 13px; color: var(--text-dim); margin-bottom: 18px; font-weight: 300; }
  .alert { padding: 12px 16px; border-radius: 8px; font-size: 13px; margin-bottom: 16px; font-family: 'DM Mono', monospace; }
  .alert-error { background: rgba(192,57,43,0.1); border: 1px solid rgba(192,57,43,0.3); color: #e07070; }
  .alert-success { background: rgba(39,174,96,0.08); border: 1px solid rgba(39,174,96,0.25); color: #70c070; }
  .import-actions { display: flex; gap: 10px; }
  .import-note { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 18px 22px; margin-top: 28px; }

  /* ── Results ── */
  .result-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 22px 26px; margin-bottom: 18px; }
  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
  .result-rank { font-size: 11px; color: var(--gold); font-family: 'DM Mono', monospace; margin-right: 10px; }
  .result-avg { font-size: 28px; color: var(--gold); font-weight: 300; line-height: 1; }
  .result-count { font-size: 10px; color: var(--text-faint); font-family: 'DM Mono', monospace; margin-top: 4px; text-align: right; }
  .reviewer-score { background: var(--surface2); border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; }
  .reviewer-score-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .reviewer-name { font-size: 11px; color: var(--text-faint); font-family: 'DM Mono', monospace; }
  .reviewer-comment { font-size: 13px; color: var(--text-dim); line-height: 1.65; font-weight: 300; }
  .not-reviewed { font-size: 11px; color: var(--text-faint); font-style: italic; font-family: 'DM Mono', monospace; }

  /* ── Reviewer panel ── */
  .reviewer-layout { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 210px; background: var(--surface); border-right: 1px solid var(--border);
    overflow-y: auto; padding: 12px 0; flex-shrink: 0; }
  .sidebar-item { width: 100%; padding: 12px 16px; background: none; border: none;
    border-left: 3px solid transparent; text-align: left; display: flex; align-items: center;
    gap: 10px; cursor: pointer; transition: all 0.15s; }
  .sidebar-item.active { background: rgba(201,168,76,0.05); border-left-color: var(--gold); }
  .sidebar-item:hover:not(.active) { background: rgba(255,255,255,0.02); }
  .sidebar-num { width: 26px; height: 26px; border-radius: 50%; background: var(--surface2);
    border: 1px solid var(--border2); display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--text-faint); flex-shrink: 0; font-family: 'DM Mono', monospace; }
  .sidebar-num.done { background: var(--gold); border-color: var(--gold); color: var(--bg); }
  .sidebar-label { font-size: 12px; color: var(--text-dim); font-family: 'DM Mono', monospace; }
  .sidebar-item.active .sidebar-label { color: var(--text); }
  .reviewer-main { flex: 1; overflow-y: auto; padding: 28px 32px; }
  .reviewer-empty { text-align: center; padding-top: 80px; color: var(--text-faint); }
  .reviewer-empty-icon { font-size: 42px; margin-bottom: 14px; opacity: 0.4; }

  /* ── Profile card ── */
  .profile-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 22px 26px; margin-bottom: 20px; }
  .profile-top { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 12px; }
  .profile-id { font-size: 22px; font-weight: 300; color: var(--text); margin-bottom: 10px; letter-spacing: 0.3px; }
  .profile-tags { display: flex; flex-wrap: wrap; gap: 6px 18px; }
  .profile-tag { font-size: 12px; color: var(--text-dim); font-weight: 300; }
  .profile-links { display: flex; gap: 8px; }
  .essay-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px 28px; margin-bottom: 20px; }
  .essay-text { font-size: 14px; line-height: 1.95; color: #d8d0bc; font-weight: 300;
    white-space: pre-wrap; letter-spacing: 0.2px; }
  .scoring-card { background: var(--surface); border: 1px solid var(--border2); border-radius: 12px;
    padding: 22px 26px; }
  .scoring-title { font-size: 13px; color: var(--gold); font-weight: 300; letter-spacing: 0.5px; margin-bottom: 20px; }

  /* ── Stars ── */
  .stars { display: flex; align-items: center; gap: 3px; }
  .star-btn { background: none; border: none; padding: 2px; font-size: 20px; transition: transform 0.1s; line-height: 1; }
  .star-btn:not(:disabled):hover { transform: scale(1.15); }
  .star-btn:disabled { cursor: default; }
  .star-label { font-size: 11px; color: var(--text-dim); margin-left: 8px; font-family: 'DM Mono', monospace; }

  /* ── Reviewers tab ── */
  .reviewer-row { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 14px 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
  .reviewer-row-name { font-size: 14px; font-weight: 300; color: var(--text); }
  .reviewer-row-pw { font-size: 11px; color: var(--text-faint); margin-top: 3px; font-family: 'DM Mono', monospace; }
  .reviewer-row-count { font-size: 11px; color: var(--text-faint); font-family: 'DM Mono', monospace; }

  /* ── Form grid ── */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }
  .form-actions { display: flex; gap: 10px; margin-top: 4px; }
  .contact-toggle { font-size: 11px; color: var(--text-faint); cursor: pointer; margin-bottom: 14px;
    font-family: 'DM Mono', monospace; display: flex; align-items: center; gap: 6px; }
  .contact-toggle:hover { color: var(--text-dim); }

  /* ── Misc ── */
  .divider { height: 1px; background: var(--border); margin: 24px 0; }
  .empty-state { text-align: center; padding: 60px 0; color: var(--text-faint); }
  .empty-icon { font-size: 36px; margin-bottom: 14px; opacity: 0.3; }
  .empty-text { font-size: 13px; font-weight: 300; }
  .save-confirm { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--green);
    font-family: 'DM Mono', monospace; }
  .row-actions-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; }
  .row-actions-header-btns { display: flex; gap: 8px; }

  @media (max-width: 640px) {
    .form-grid { grid-template-columns: 1fr; }
    .login-box { width: 95vw; padding: 36px 24px; }
    .reviewer-main { padding: 20px 16px; }
    .sidebar { width: 170px; }
  }

  /* ── File viewer modal ── */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85);
    z-index:1000; align-items:center; justify-content:center; padding:24px; }
  .modal-overlay.open { display:flex; }
  .modal-box { background:var(--surface); border:1px solid var(--border2); border-radius:14px;
    width:100%; max-width:860px; height:88vh; display:flex; flex-direction:column;
    box-shadow:0 40px 80px rgba(0,0,0,.8); overflow:hidden; }
  .modal-header { display:flex; align-items:center; justify-content:space-between;
    padding:14px 20px; border-bottom:1px solid var(--border); flex-shrink:0; }
  .modal-title { font-size:13px; color:var(--text-dim); font-family:'DM Mono',monospace; letter-spacing:.5px; }
  .modal-close { background:none; border:1px solid var(--border2); border-radius:6px;
    color:var(--text-dim); padding:5px 12px; font-size:12px; cursor:pointer;
    font-family:'DM Mono',monospace; transition:all .15s; }
  .modal-close:hover { border-color:var(--gold-dim); color:var(--gold); }
  .modal-body { flex:1; overflow:hidden; }
  .modal-body iframe { width:100%; height:100%; border:none; background:#fff; }
  .modal-body img { width:100%; height:100%; object-fit:contain; background:#111; }

  /* ── Loading screen ── */
  #loading-screen { align-items:center; justify-content:center; background:var(--bg); }
  .loading-inner { text-align:center; }
  .loading-spinner { font-size:36px; color:var(--gold); animation:spin 2s linear infinite; display:inline-block; margin-bottom:16px; }
  @keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  .loading-msg { font-size:13px; color:var(--text-faint); font-family:'DM Mono',monospace; letter-spacing:.5px; }
</style>
</head>
<body>
<div id="app">

  <!-- ═══ LOADING ═══ -->
  <div id="loading-screen" class="screen">
    <div class="loading-inner">
      <div class="loading-spinner">✦</div>
      <div class="loading-msg" id="loading-msg">Loading…</div>
    </div>
  </div>

  <!-- ═══ LOGIN ═══ -->
  <div id="login-screen" class="screen active">
    <div class="login-box">
      <div class="login-logo">✦</div>
      <div class="login-title">
        <h1>Patricia Saidu Memorial<br>Health Fellows Scholarship</h1>
        <p>Baton Rouge Youth Coalition · Review Portal</p>
      </div>
      <div class="field-group">
        <label class="field-label">Your Name</label>
        <select id="login-select" class="field-input">
          <option value="">— Select your name —</option>
        </select>
      </div>
      <div class="field-group">
        <label class="field-label">Password</label>
        <input type="password" id="login-pw" class="field-input" placeholder="Enter your password">
        <div id="login-error" style="color:var(--red);font-size:12px;margin-top:6px;font-family:'DM Mono',monospace;display:none"></div>
      </div>
      <button class="btn-primary" id="login-btn" style="width:100%;padding:13px;" onclick="doLogin()">Sign In</button>
    </div>
  </div>

  <!-- ═══ ADMIN ═══ -->
  <div id="admin-screen" class="screen">
    <div class="app-header">
      <div class="header-left">
        <div class="header-logo">✦</div>
        <div class="header-title">Patricia Saidu Memorial · <span style="color:var(--text-faint);font-size:11px;font-family:'DM Mono',monospace">ADMIN</span></div>
        <nav class="header-nav">
          <button class="nav-btn active" onclick="showTab('applicants')">Applicants</button>
          <button class="nav-btn" onclick="showTab('results')">Results</button>
          <button class="nav-btn" onclick="showTab('reviewers')">Reviewers</button>
        </nav>
      </div>
      <div class="header-right">
        <button class="btn-outline" onclick="logout()">Sign Out</button>
      </div>
    </div>

    <!-- APPLICANTS TAB -->
    <div id="tab-applicants" class="main-content">
      <div class="row-actions-header">
        <h2 class="page-title" style="margin:0">Applicants <span id="applicant-count" style="font-size:14px;color:var(--text-faint)"></span></h2>
        <div class="row-actions-header-btns">
          <button class="btn-primary" onclick="openAddForm()">+ Add Manually</button>
        </div>
      </div>

      <!-- Add/Edit form -->
      <div id="applicant-form" style="display:none" class="card" style="margin-bottom:24px">
        <div class="card-title" id="form-title">Add Applicant</div>
        <div class="form-grid">
          <div class="field-group"><label class="field-label">BRYC ID *</label><input class="field-input" id="f-brycId" placeholder="BRYC001"></div>
          <div class="field-group"><label class="field-label">High School</label><input class="field-input" id="f-school" placeholder="Belaire High School"></div>
          <div class="field-group"><label class="field-label">HS Graduation Year</label><input class="field-input" id="f-gradYear" placeholder="2022"></div>
          <div class="field-group"><label class="field-label">College Name</label><input class="field-input" id="f-collegeName" placeholder="LSU"></div>
          <div class="field-group"><label class="field-label">College Graduation Year</label><input class="field-input" id="f-collegeGradYear" placeholder="2026"></div>
          <div class="field-group"><label class="field-label">Major / Minor</label><input class="field-input" id="f-major" placeholder="Biology major, Chemistry minor"></div>
          <div class="field-group"><label class="field-label">Attending Medical School?</label><input class="field-input" id="f-medSchool" placeholder="Yes / No"></div>
          <div class="field-group"><label class="field-label">Health Career Path (if not med school)</label><input class="field-input" id="f-careerPath" placeholder="Healthcare administration"></div>
        </div>
        <div class="field-group"><label class="field-label">Career Aspirations Essay *</label>
          <textarea class="field-input" id="f-essay" rows="7" placeholder="Paste essay here…"></textarea></div>
        <div class="form-grid">
          <div class="field-group"><label class="field-label">Photo URL (Google Drive link)</label><input class="field-input" id="f-photoUrl" placeholder="https://drive.google.com/..."></div>
          <div class="field-group"><label class="field-label">Résumé URL (Google Drive link)</label><input class="field-input" id="f-resumeUrl" placeholder="https://drive.google.com/..."></div>
        </div>
        <details style="margin-bottom:16px">
          <summary class="contact-toggle">▸ Contact info (admin only — hidden from reviewers)</summary>
          <div class="form-grid" style="margin-top:14px">
            <div class="field-group"><label class="field-label">Cell Phone</label><input class="field-input" id="f-phone" placeholder="(225) 555-1234"></div>
            <div class="field-group"><label class="field-label">Email</label><input class="field-input" id="f-email" placeholder="applicant@email.com"></div>
            <div class="field-group"><label class="field-label">Instagram</label><input class="field-input" id="f-instagram" placeholder="@handle"></div>
          </div>
        </details>
        <div class="form-actions">
          <button class="btn-primary" onclick="saveApplicant()" id="save-applicant-btn">Save Applicant</button>
          <button class="btn-outline" onclick="cancelForm()">Cancel</button>
        </div>
      </div>

      <div id="applicant-list"></div>
    </div>


    <!-- RESULTS TAB -->
    <div id="tab-results" class="main-content" style="display:none">
      <h2 class="page-title">Review Results</h2>
      <div id="results-list"></div>
    </div>

    <!-- REVIEWERS TAB -->
    <div id="tab-reviewers" class="main-content" style="display:none">
      <h2 class="page-title">Manage Reviewers</h2>
      <p class="page-subtitle">Share each person's name and password with them privately before the review period begins.</p>
      <div id="reviewer-list"></div>
      <div class="divider"></div>
      <div class="card">
        <div class="card-title">Add Reviewer</div>
        <div class="form-grid">
          <div class="field-group"><label class="field-label">Name</label><input class="field-input" id="new-rv-name" placeholder="Committee member name"></div>
          <div class="field-group"><label class="field-label">Password</label><input class="field-input" id="new-rv-pw" placeholder="Assign a password"></div>
        </div>
        <button class="btn-primary" onclick="addReviewer()">Add Reviewer</button>
      </div>
    </div>
  </div>

  <!-- ═══ REVIEWER ═══ -->
  <div id="reviewer-screen" class="screen">
    <div class="app-header">
      <div class="header-left">
        <div class="header-logo">✦</div>
        <div class="header-title">Patricia Saidu Memorial Scholarship</div>
        <div class="header-user" id="rv-user-name"></div>
      </div>
      <div class="header-right">
        <span class="progress-text" id="rv-progress"></span>
        <button class="btn-outline" onclick="logout()">Sign Out</button>
      </div>
    </div>
    <div class="reviewer-layout">
      <div class="sidebar" id="rv-sidebar"></div>
      <div class="reviewer-main" id="rv-main">
        <div class="reviewer-empty">
          <div class="reviewer-empty-icon">✦</div>
          <p style="font-size:13px;font-weight:300">Select an applicant from the sidebar to begin</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══ FILE VIEWER MODAL ═══ -->
  <div id="file-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title" id="modal-title"></span>
        <button class="modal-close" onclick="document.getElementById('file-modal').classList.remove('open')">✕ Close</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

</div>

<script>
// -- Configuration --
// Paste your Apps Script Web App URL here after deploying
// API_URL auto-detects whether this is running inside Apps Script or locally.
// If running locally, paste your Web App URL between the quotes below.
const API_URL = (function() {
  const local = 'https://script.google.com/macros/s/AKfycbxji1xSEk2N63raK0ARvQJD2m-jGkVQzN50DGp8nJCLhu15ZmvEObp5HEZOy2x5FBim/exec';
  // When served by Apps Script, window.location is the web app URL itself
  const loc = window.location.href;
  if (loc.includes('script.google.com/macros')) return loc.split('?')[0];
  return local;
})();

// -- State --
const STATE = {
  currentUser: null,
  applicants: [],
  reviews: {},
  reviewers: [],
  editingId: null,
  currentTab: 'applicants',
  selectedApplicant: null,
};

// -- API helpers --
async function apiGet(action) {
  const res = await fetch(`${API_URL}?action=${action}`);
  return res.json();
}

async function apiPost(body) {
  const res = await fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(body),
  });
  return res.json();
}

// -- Loading screen --
function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg || 'Loading-';
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('loading-screen').classList.add('active');
}

function hideLoading() {
  document.getElementById('loading-screen').classList.remove('active');
}

// -- Stars --
const STAR_LABELS = ['','Poor','Fair','Good','Strong','Exceptional'];
function starsHTML(value, readonly, id) {
  let html = '<div class="stars">';
  for (let n = 1; n <= 5; n++) {
    const filled = n <= value;
    const onclick = readonly ? '' : `onclick="setStar('${id}',${n})"`;
    const onmouse = readonly ? '' : `onmouseenter="hoverStar('${id}',${n})" onmouseleave="unhoverStar('${id}',${value})"`;
    html += `<button class="star-btn" ${readonly?'disabled':''} ${onclick} ${onmouse} style="color:${filled?'var(--gold)':'var(--text-faint)'}">-</button>`;
  }
  html += `<span class="star-label" id="star-label-${id}">${value > 0 ? STAR_LABELS[value] : ''}</span>`;
  html += '</div>';
  return html;
}

let currentStarScore = 0;
function setStar(id, n) {
  currentStarScore = n;
  unhoverStar(id, n);
  const btn = document.getElementById('save-review-btn');
  if (btn) btn.disabled = false;
}
function hoverStar(id, n) {
  const wrap = document.querySelector(`#stars-${id}`);
  if (!wrap) return;
  wrap.querySelectorAll('.star-btn').forEach((btn, i) => {
    btn.style.color = i < n ? 'var(--gold-light)' : 'var(--text-faint)';
  });
  const lbl = document.getElementById(`star-label-${id}`);
  if (lbl) lbl.textContent = STAR_LABELS[n];
}
function unhoverStar(id, n) {
  const wrap = document.querySelector(`#stars-${id}`);
  if (!wrap) return;
  wrap.querySelectorAll('.star-btn').forEach((btn, i) => {
    btn.style.color = i < n ? 'var(--gold)' : 'var(--text-faint)';
  });
  const lbl = document.getElementById(`star-label-${id}`);
  if (lbl) lbl.textContent = n > 0 ? STAR_LABELS[n] : '';
}

// -- Score summary --
function getScoreMap() {
  const map = {};
  STATE.reviewers.filter(r => r.role === 'reviewer').forEach(r => {
    STATE.applicants.forEach(a => {
      const rev = STATE.reviews[`${r.id}:${a.id}`];
      if (rev) {
        if (!map[a.id]) map[a.id] = { total: 0, count: 0 };
        map[a.id].total += rev.score;
        map[a.id].count++;
      }
    });
  });
  return map;
}

// -- Login --
function populateLoginSelect() {
  const sel = document.getElementById('login-select');
  sel.innerHTML = '<option value="">- Select your name -</option>';
  STATE.reviewers.forEach(r => {
    sel.innerHTML += `<option value="${r.id}">${r.name}</option>`;
  });
}

function doLogin() {
  const selId = document.getElementById('login-select').value;
  const pw = document.getElementById('login-pw').value;
  const err = document.getElementById('login-error');
  const reviewer = STATE.reviewers.find(r => r.id === selId);
  if (reviewer && reviewer.password === pw) {
    STATE.currentUser = reviewer;
    err.style.display = 'none';
    document.getElementById('login-screen').classList.remove('active');
    if (reviewer.role === 'admin') {
      document.getElementById('admin-screen').classList.add('active');
      showTab('applicants');
    } else {
      document.getElementById('reviewer-screen').classList.add('active');
      document.getElementById('rv-user-name').textContent = reviewer.name;
      renderReviewerSidebar();
      renderReviewerMain(null);
    }
  } else {
    err.textContent = 'Incorrect password. Try again.';
    err.style.display = 'block';
  }
}

document.getElementById('login-pw').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

function logout() {
  STATE.currentUser = null;
  STATE.selectedApplicant = null;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('login-screen').classList.add('active');
  document.getElementById('login-pw').value = '';
  document.getElementById('login-error').style.display = 'none';
}

// -- Admin tabs --
function showTab(tab) {
  STATE.currentTab = tab;
  document.querySelectorAll('.nav-btn').forEach((btn, i) => {
    const tabs = ['applicants','results','reviewers'];
    btn.classList.toggle('active', tabs[i] === tab);
  });
  document.getElementById('tab-applicants').style.display = tab==='applicants' ? 'block' : 'none';
  document.getElementById('tab-results').style.display    = tab==='results'     ? 'block' : 'none';
  document.getElementById('tab-reviewers').style.display  = tab==='reviewers'   ? 'block' : 'none';
  if (tab === 'applicants') renderApplicantList();
  if (tab === 'results')    renderResults();
  if (tab === 'reviewers')  renderReviewerList();
}

// -- Applicant list --
function renderApplicantList() {
  const el = document.getElementById('applicant-list');
  document.getElementById('applicant-count').textContent = `(${STATE.applicants.length})`;
  if (STATE.applicants.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">-</div><div class="empty-text">No applicants loaded. Check your Web App URL configuration.</div></div>';
    return;
  }
  const sm = getScoreMap();
  el.innerHTML = STATE.applicants.map((a, i) => {
    const score = sm[a.id];
    const avg = score ? (score.total/score.count).toFixed(1) : null;
    const meta = [a.school, a.gradYear?`'${String(a.gradYear).slice(-2)}`:null, a.major].filter(Boolean).join(' - ');
    return `
      <div class="applicant-row">
        <div class="applicant-row-top">
          <div>
            <div class="applicant-id">${a.brycId}</div>
            <div class="applicant-meta">${meta || '-'}</div>
          </div>
          <div class="applicant-actions">
            ${avg ? `<span class="avg-badge">avg ${avg}/5 <span style="color:var(--text-faint)">(${score.count})</span></span>` : ''}
          </div>
        </div>
        ${(!a.photoUrl || !a.resumeUrl) ? `
        <div class="link-inputs">
          ${!a.photoUrl ? `<div class="link-input-wrap"><input class="field-input" style="font-size:11px;padding:7px 10px" placeholder="Paste photo Drive link - press Enter" onblur="saveLink('${a.brycId}','photoUrl',this)" onkeydown="if(event.key==='Enter')saveLink('${a.brycId}','photoUrl',this)"></div>` : ''}
          ${!a.resumeUrl ? `<div class="link-input-wrap"><input class="field-input" style="font-size:11px;padding:7px 10px" placeholder="Paste r-sum- Drive link - press Enter" onblur="saveLink('${a.brycId}','resumeUrl',this)" onkeydown="if(event.key==='Enter')saveLink('${a.brycId}','resumeUrl',this)"></div>` : ''}
        </div>` : ''}
        ${(a.photoUrl || a.resumeUrl) ? `
        <div class="link-badges">
          ${a.photoUrl ? `<button onclick="openFile('${a.photoUrl}','${a.brycId} - Photo','photo')" class="link-badge" style="border:none;cursor:pointer">- Photo -</button>` : ''}
          ${a.resumeUrl ? `<button onclick="openFile('${a.resumeUrl}','${a.brycId} - R-sum-','resume')" class="link-badge" style="border:none;cursor:pointer">- R-sum- -</button>` : ''}
        </div>` : ''}
      </div>`;
  }).join('');
}

async function saveLink(brycId, field, inputEl) {
  const val = inputEl.value.trim();
  if (!val) return;
  inputEl.disabled = true;
  inputEl.value = 'Saving-';
  const a = STATE.applicants.find(a => a.brycId === brycId);
  if (a) a[field] = val;
  await apiPost({ action: 'saveLink', brycId, field, value: val });
  renderApplicantList();
}

// -- Results --
function renderResults() {
  const el = document.getElementById('results-list');
  if (STATE.applicants.length === 0) {
    el.innerHTML = '<p style="color:var(--text-faint);font-size:13px">No applicants loaded.</p>'; return;
  }
  const sm = getScoreMap();
  const sorted = [...STATE.applicants]
    .map(a => ({ ...a, avg: sm[a.id] ? sm[a.id].total/sm[a.id].count : 0, cnt: sm[a.id]?.count||0 }))
    .sort((a,b) => b.avg - a.avg);
  el.innerHTML = sorted.map((a, rank) => {
    const rvScores = STATE.reviewers.filter(r=>r.role==='reviewer').map(r => ({
      name: r.name, data: STATE.reviews[`${r.id}:${a.id}`] || null
    }));
    return `
      <div class="result-card">
        <div class="result-header">
          <div>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:5px">
              <span class="result-rank">#${rank+1}</span>
              <span style="font-size:17px;font-weight:300">${a.brycId}</span>
            </div>
            <div style="font-size:12px;color:var(--text-faint);font-family:'DM Mono',monospace">${[a.school,a.collegeName,a.major].filter(Boolean).join(' - ')}</div>
          </div>
          ${a.cnt > 0 ? `<div><div class="result-avg">${a.avg.toFixed(1)}</div><div class="result-count">${a.cnt} review${a.cnt!==1?'s':''}</div></div>` : ''}
        </div>
        ${rvScores.map(({name,data}) => `
          <div class="reviewer-score">
            <div class="reviewer-score-top">
              <span class="reviewer-name">${name}</span>
              ${data ? starsHTML(data.score, true, name+a.id) : '<span class="not-reviewed">Not yet reviewed</span>'}
            </div>
            ${data?.comment ? `<div class="reviewer-comment">${escHtml(data.comment)}</div>` : ''}
          </div>`).join('')}
      </div>`;
  }).join('');
}

// -- Reviewer management --
function renderReviewerList() {
  const el = document.getElementById('reviewer-list');
  el.innerHTML = STATE.reviewers.filter(r=>r.role==='reviewer').map(r => {
    const done = STATE.applicants.filter(a => STATE.reviews[`${r.id}:${a.id}`]).length;
    return `
      <div class="reviewer-row">
        <div>
          <div class="reviewer-row-name">${r.name}</div>
          <div class="reviewer-row-pw">Password: ${r.password}</div>
        </div>
        <span class="reviewer-row-count">${done}/${STATE.applicants.length} reviewed</span>
      </div>`;
  }).join('');
}

async function addReviewer() {
  const name = document.getElementById('new-rv-name').value.trim();
  const pw   = document.getElementById('new-rv-pw').value.trim();
  if (!name || !pw) return;
  STATE.reviewers.push({ id: 'rv_'+Date.now(), name, password: pw, role: 'reviewer' });
  await apiPost({ action: 'saveReviewers', reviewers: STATE.reviewers });
  document.getElementById('new-rv-name').value = '';
  document.getElementById('new-rv-pw').value = '';
  populateLoginSelect();
  renderReviewerList();
}

// -- Reviewer panel --
function renderReviewerSidebar() {
  const el = document.getElementById('rv-sidebar');
  const u = STATE.currentUser;
  if (STATE.applicants.length === 0) {
    el.innerHTML = '<p style="color:var(--text-faint);font-size:11px;padding:16px;font-family:monospace">No applicants loaded.</p>';
    return;
  }
  el.innerHTML = STATE.applicants.map((a, i) => {
    const reviewed = !!STATE.reviews[`${u.id}:${a.id}`];
    const active = STATE.selectedApplicant?.id === a.id;
    return `
      <button class="sidebar-item ${active?'active':''}" onclick="selectApplicant('${a.id}')">
        <div class="sidebar-num ${reviewed?'done':''}">${reviewed?'-':i+1}</div>
        <span class="sidebar-label">${a.brycId}</span>
      </button>`;
  }).join('');
  const done = STATE.applicants.filter(a => STATE.reviews[`${u.id}:${a.id}`]).length;
  document.getElementById('rv-progress').textContent = `${done}/${STATE.applicants.length} reviewed`;
}

function selectApplicant(id) {
  const a = STATE.applicants.find(a => a.id === id);
  if (!a) return;
  STATE.selectedApplicant = a;
  const ex = STATE.reviews[`${STATE.currentUser.id}:${a.id}`];
  currentStarScore = ex?.score || 0;
  renderReviewerSidebar();
  renderReviewerMain(a, ex);
}

function renderReviewerMain(a, ex) {
  const el = document.getElementById('rv-main');
  if (!a) {
    el.innerHTML = '<div class="reviewer-empty"><div class="reviewer-empty-icon">-</div><p style="font-size:13px;font-weight:300">Select an applicant from the sidebar to begin</p></div>';
    return;
  }
  const tags = [
    a.school ? `- ${a.school}${a.gradYear?' ('+a.gradYear+')':''}` : null,
    a.collegeName ? `- ${a.collegeName}${a.collegeGradYear?' ('+a.collegeGradYear+')':''}` : null,
    a.major ? `- ${a.major}` : null,
    a.medSchool ? `- Med school: ${a.medSchool}` : null,
    a.careerPath ? `- ${a.careerPath}` : null,
  ].filter(Boolean);

  el.innerHTML = `
    <div style="max-width:700px">
      <div class="profile-card">
        <div class="profile-top">
          <div>
            <div class="profile-id">${a.brycId}</div>
            <div class="profile-tags">${tags.map(t=>`<span class="profile-tag">${t}</span>`).join('')}</div>
          </div>
          <div class="profile-links">
            ${a.photoUrl  ? `<button onclick="openFile('${a.photoUrl}','${a.brycId} - Photo','photo')" class="link-badge" style="border:none;cursor:pointer">- Photo</button>` : ''}
            ${a.resumeUrl ? `<button onclick="openFile('${a.resumeUrl}','${a.brycId} - R-sum-','resume')" class="link-badge" style="border:none;cursor:pointer">- R-sum-</button>` : ''}
          </div>
        </div>
      </div>
      <div class="essay-card">
        <div class="card-title">Career Aspirations Essay</div>
        <div class="essay-text">${escHtml(a.essay || '(No essay provided)')}</div>
      </div>
      <div class="scoring-card">
        <div class="scoring-title">Your Review</div>
        <div class="field-group">
          <label class="field-label">Essay Score *</label>
          <div id="stars-review">${starsHTML(currentStarScore, false, 'review')}</div>
        </div>
        <div class="field-group">
          <label class="field-label">Comments (optional)</label>
          <textarea class="field-input" id="rv-comment" rows="4" placeholder="Notes for the committee-">${escHtml(ex?.comment||'')}</textarea>
        </div>
        <div style="display:flex;align-items:center;gap:14px">
          <button class="btn-primary" id="save-review-btn" onclick="saveReview()" ${currentStarScore===0?'disabled':''}>Save Review</button>
          <div id="rv-saved" class="save-confirm" style="display:none">- Saved</div>
        </div>
      </div>
    </div>`;
}

async function saveReview() {
  const a = STATE.selectedApplicant;
  if (!a || currentStarScore === 0) return;
  const btn = document.getElementById('save-review-btn');
  btn.textContent = 'Saving-'; btn.disabled = true;
  const comment = document.getElementById('rv-comment').value;
  const key = `${STATE.currentUser.id}:${a.id}`;
  STATE.reviews[key] = { score: currentStarScore, comment };
  await apiPost({ action: 'saveReview', reviewerId: STATE.currentUser.id,
    applicantId: a.id, score: currentStarScore, comment });
  btn.textContent = 'Save Review'; btn.disabled = false;
  const saved = document.getElementById('rv-saved');
  saved.style.display = 'flex';
  setTimeout(() => { if(saved) saved.style.display='none'; }, 2500);
  renderReviewerSidebar();
}

// -- File viewer modal --
function driveEmbedUrl(url) {
  let id = null;
  const m1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  else if (m2) id = m2[1];
  if (!id) return url;
  return `https://drive.google.com/file/d/${id}/preview`;
}

function openFile(url, label, type) {
  const modal = document.getElementById('file-modal');
  const body  = document.getElementById('modal-body');
  document.getElementById('modal-title').textContent = label;
  body.innerHTML = `<iframe src="${driveEmbedUrl(url)}" allowfullscreen></iframe>`;
  modal.classList.add('open');
}

function closeModal(e) {
  if (e.target === document.getElementById('file-modal'))
    document.getElementById('file-modal').classList.remove('open');
}

// -- Utilities --
function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// -- Init --
async function init() {
  showLoading('Loading applicants-');
  try {
    const data = await apiGet('getAll');
    if (data.error) throw new Error(data.error);
    STATE.applicants = data.applicants || [];
    STATE.reviews    = data.reviews    || {};
    STATE.reviewers  = data.reviewers  || [];
    populateLoginSelect();
    hideLoading();
    document.getElementById('login-screen').classList.add('active');
  } catch(e) {
    hideLoading();
    document.getElementById('login-screen').classList.add('active');
    document.getElementById('login-error').textContent = '- Could not connect: ' + e.message;
    document.getElementById('login-error').style.display = 'block';
  }
}

init();
</script>
</body>
</html>
