<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patricia Saidu Memorial Health Fellows Scholarship - Review Portal</title>
<link rel="stylesheet" href="https://use.typekit.net/oyd0hvb.css">
<style>
  :root {
    --green:      #0e5640;
    --green-light:#acd572;
    --blue:       #7fd1e0;
    --bg:         #05120e;
    --surface:    #091a14;
    --surface2:   #0d2119;
    --border:     #122d20;
    --border2:    #1a3d2a;
    --text:       #e8f0e4;
    --text-dim:   #7a9a84;
    --text-faint: #2a4a36;
    --red:        #c0392b;
    --gold:       #acd572;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: proxima-nova, sans-serif;
    min-height: 100vh; font-size: 16px; }
  button { font-family: inherit; cursor: pointer; }
  input, select, textarea { font-family: proxima-nova, sans-serif; }

  /* Layout */
  #app { min-height: 100vh; }
  .screen { display: none; }
  .screen.active { display: flex; flex-direction: column; min-height: 100vh; }

  /* Logo bug */
  .logo-bug { position: fixed; top: 14px; left: 18px; z-index: 100;
    width: 38px; height: 38px; border-radius: 50%; overflow: hidden;
    border: 1px solid var(--border2); }
  .logo-bug img { width: 100%; height: 100%; object-fit: cover; }

  /* Loading */
  #loading-screen { align-items: center; justify-content: center; background: var(--bg); }
  .loading-inner { text-align: center; }
  .loading-spinner { font-size: 32px; color: var(--green-light);
    animation: spin 2s linear infinite; display: inline-block; margin-bottom: 16px; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .loading-msg { font-size: 13px; color: var(--text-faint); letter-spacing: 0.5px; }

  /* Login */
  #login-screen { align-items: center; justify-content: center; background: var(--bg); }
  .login-box { width: 400px; padding: 48px 40px; background: var(--surface);
    border: 1px solid var(--border2); border-radius: 16px;
    box-shadow: 0 60px 120px rgba(0,0,0,0.8); }
  .login-logo-wrap { text-align: center; margin-bottom: 20px; }
  .login-logo-wrap img { width: 60px; height: 60px; border-radius: 50%; }
  .login-title { text-align: center; margin-bottom: 32px; }
  .login-title h1 { font-size: 18px; font-weight: 600; line-height: 1.5; color: var(--text); }
  .login-title p { font-size: 11px; letter-spacing: 1.2px; color: var(--text-faint); margin-top: 6px;
    text-transform: uppercase; }

  /* Form elements */
  .field-label { display: block; font-size: 11px; letter-spacing: 1px; color: var(--text-dim);
    text-transform: uppercase; font-weight: 600; margin-bottom: 7px; }
  .field-input { width: 100%; padding: 11px 13px; background: rgba(255,255,255,0.03);
    border: 1px solid var(--border2); border-radius: 7px; color: var(--text);
    font-size: 14px; outline: none; transition: border-color 0.2s; }
  .field-input:focus { border-color: var(--green); }
  .field-group { margin-bottom: 16px; }
  textarea.field-input { resize: vertical; line-height: 1.8; }

  /* Buttons */
  .btn-primary { padding: 12px 24px; background: var(--green);
    border: none; border-radius: 8px; color: #fff; font-size: 13px; font-weight: 700;
    letter-spacing: 0.5px; transition: opacity 0.2s; }
  .btn-primary:hover { opacity: 0.88; }
  .btn-primary:disabled { background: var(--border2); color: var(--text-faint); cursor: not-allowed; opacity: 1; }
  .btn-outline { padding: 9px 18px; background: none; border: 1px solid var(--border2);
    border-radius: 7px; color: var(--text-dim); font-size: 12px; font-weight: 600;
    transition: border-color 0.2s; letter-spacing: 0.3px; }
  .btn-outline:hover { border-color: var(--green); color: var(--green-light); }

  /* Header */
  .app-header { height: 56px; background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 0 28px 0 68px; display: flex; align-items: center;
    justify-content: space-between; flex-shrink: 0; }
  .header-left { display: flex; align-items: center; gap: 20px; }
  .header-title { color: var(--text-dim); font-size: 13px; font-weight: 400; letter-spacing: 0.3px; }
  .header-user { color: var(--text-faint); font-size: 11px; font-weight: 600; letter-spacing: 0.5px; }
  .header-nav { display: flex; gap: 3px; }
  .nav-btn { padding: 6px 14px; border: none; border-radius: 6px; font-size: 11px;
    letter-spacing: 0.5px; text-transform: uppercase; font-weight: 700; transition: all 0.15s; }
  .nav-btn.active { background: var(--green); color: #fff; }
  .nav-btn:not(.active) { background: none; color: var(--text-faint); }
  .nav-btn:not(.active):hover { color: var(--text-dim); }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .progress-text { font-size: 11px; color: var(--text-faint); font-weight: 600; letter-spacing: 0.3px; }

  /* Main content */
  .main-content { flex: 1; overflow-y: auto; padding: 32px 28px;
    max-width: 920px; margin: 0 auto; width: 100%; }
  .page-title { font-size: 22px; font-weight: 700; color: var(--text);
    margin-bottom: 24px; letter-spacing: 0.2px; }
  .page-subtitle { font-size: 13px; color: var(--text-dim); line-height: 1.7; margin-bottom: 28px; }

  /* Group section headers */
  .group-section { margin-bottom: 36px; }
  .group-header { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; padding-bottom: 10px;
    border-bottom: 1px solid var(--border2); }
  .group-label { font-size: 11px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--green-light); }
  .group-count { font-size: 11px; color: var(--text-faint); font-weight: 600; }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 11px; padding: 22px 24px; }
  .card + .card { margin-top: 12px; }
  .card-title { font-size: 11px; letter-spacing: 1.2px; text-transform: uppercase;
    font-weight: 700; color: var(--text-dim); margin-bottom: 16px; }

  /* Applicant list */
  .applicant-row { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px 20px; margin-bottom: 10px; }
  .applicant-row-top { display: flex; justify-content: space-between; align-items: center; }
  .applicant-id { font-size: 15px; color: var(--text); font-weight: 600; }
  .applicant-meta { font-size: 12px; color: var(--text-faint); margin-top: 3px; }
  .applicant-actions { display: flex; align-items: center; gap: 10px; }
  .avg-badge { font-size: 12px; color: var(--green-light); font-weight: 700; }
  .link-inputs { display: flex; gap: 10px; margin-top: 12px; }
  .link-input-wrap { flex: 1; }
  .link-badges { display: flex; gap: 8px; margin-top: 10px; }
  .link-badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px;
    background: rgba(172,213,114,0.08); border: 1px solid rgba(172,213,114,0.2); border-radius: 6px;
    color: var(--green-light); font-size: 11px; font-weight: 600; text-decoration: none; }
  .link-badge:hover { background: rgba(172,213,114,0.14); }

  /* Results */
  .winner-section { margin-bottom: 40px; }
  .winner-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px;
    padding-bottom: 12px; border-bottom: 2px solid var(--border2); }
  .winner-label { font-size: 13px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; color: var(--green-light); }
  .winner-sublabel { font-size: 11px; color: var(--text-faint); font-weight: 600; }
  .result-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px 24px; margin-bottom: 12px; }
  .result-card.winner { border-color: rgba(172,213,114,0.4); background: rgba(172,213,114,0.04); }
  .result-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
  .result-rank { font-size: 18px; font-weight: 700; color: var(--green-light); margin-right: 10px; }
  .result-avg { font-size: 26px; color: var(--green-light); font-weight: 700; line-height: 1; }
  .result-avg-label { font-size: 10px; color: var(--text-faint); font-weight: 600;
    letter-spacing: 0.5px; margin-top: 3px; text-align: right; }
  .reviewer-score { background: var(--surface2); border-radius: 8px; padding: 10px 14px; margin-bottom: 8px; }
  .reviewer-score-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .reviewer-name { font-size: 11px; color: var(--text-faint); font-weight: 700; letter-spacing: 0.3px; }
  .reviewer-comment { font-size: 13px; color: var(--text-dim); line-height: 1.65; }
  .not-reviewed { font-size: 11px; color: var(--text-faint); font-style: italic; }
  .score-breakdown { display: flex; gap: 8px; flex-wrap: wrap; }
  .score-pill { font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 700;
    background: rgba(172,213,114,0.1); color: var(--green-light); border: 1px solid rgba(172,213,114,0.2); }

  /* Reviewer panel */
  .reviewer-layout { display: flex; flex: 1; overflow: hidden; }
  .sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border);
    overflow-y: auto; padding: 12px 0; flex-shrink: 0; }
  .sidebar-group-label { font-size: 10px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--text-faint); padding: 14px 16px 6px; }
  .sidebar-item { width: 100%; padding: 10px 16px; background: none; border: none;
    border-left: 3px solid transparent; text-align: left; display: flex; align-items: center;
    gap: 10px; cursor: pointer; transition: all 0.15s; }
  .sidebar-item.active { background: rgba(172,213,114,0.06); border-left-color: var(--green-light); }
  .sidebar-item:hover:not(.active) { background: rgba(255,255,255,0.02); }
  .sidebar-num { width: 24px; height: 24px; border-radius: 50%; background: var(--surface2);
    border: 1px solid var(--border2); display: flex; align-items: center; justify-content: center;
    font-size: 10px; color: var(--text-faint); flex-shrink: 0; font-weight: 700; }
  .sidebar-num.done { background: var(--green); border-color: var(--green); color: #fff; }
  .sidebar-label { font-size: 12px; color: var(--text-dim); font-weight: 600; }
  .sidebar-item.active .sidebar-label { color: var(--text); }
  .reviewer-main { flex: 1; overflow-y: auto; padding: 28px 32px; }
  .reviewer-empty { text-align: center; padding-top: 80px; color: var(--text-faint); }
  .reviewer-empty-icon { font-size: 36px; margin-bottom: 14px; opacity: 0.4; }

  /* Profile card */
  .profile-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 22px 26px; margin-bottom: 20px; }
  .profile-top { display: flex; justify-content: space-between; align-items: flex-start;
    flex-wrap: wrap; gap: 12px; }
  .profile-id { font-size: 22px; font-weight: 700; color: var(--text); margin-bottom: 8px; }
  .profile-group-badge { display: inline-block; font-size: 10px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; padding: 3px 10px; border-radius: 4px;
    margin-bottom: 10px; }
  .badge-hs { background: rgba(127,209,224,0.12); color: var(--blue); border: 1px solid rgba(127,209,224,0.3); }
  .badge-college { background: rgba(172,213,114,0.12); color: var(--green-light); border: 1px solid rgba(172,213,114,0.3); }
  .badge-alumni { background: rgba(14,86,64,0.3); color: #7ecfa0; border: 1px solid rgba(14,86,64,0.5); }
  .profile-tags { display: flex; flex-wrap: wrap; gap: 6px 16px; margin-top: 4px; }
  .profile-tag { font-size: 12px; color: var(--text-dim); }
  .profile-links { display: flex; gap: 8px; margin-top: 4px; }
  .essay-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 24px 28px; margin-bottom: 20px; }
  .essay-text { font-size: 15px; line-height: 2; color: var(--text); white-space: pre-wrap; }

  /* Rubric scoring */
  .scoring-card { background: var(--surface); border: 1px solid var(--border2); border-radius: 12px;
    padding: 24px 28px; margin-bottom: 20px; }
  .scoring-title { font-size: 14px; font-weight: 700; color: var(--green-light);
    letter-spacing: 0.3px; margin-bottom: 6px; }
  .scoring-prompt { font-size: 12px; color: var(--text-faint); margin-bottom: 24px; line-height: 1.6; }
  .rubric-category { margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border); }
  .rubric-category:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .rubric-cat-name { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 4px; }
  .rubric-cat-desc { font-size: 12px; color: var(--text-dim); margin-bottom: 14px; font-style: italic; line-height: 1.5; }
  .rubric-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
  .rubric-option { position: relative; }
  .rubric-option input[type=radio] { position: absolute; opacity: 0; width: 0; height: 0; }
  .rubric-option label { display: block; padding: 10px 8px; border: 1px solid var(--border2);
    border-radius: 8px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .rubric-option input:checked + label { border-color: var(--green); background: rgba(14,86,64,0.2); }
  .rubric-option label:hover { border-color: var(--green); }
  .rubric-score-num { font-size: 18px; font-weight: 700; color: var(--green-light);
    display: block; margin-bottom: 4px; }
  .rubric-score-title { font-size: 11px; font-weight: 700; color: var(--text);
    display: block; margin-bottom: 6px; letter-spacing: 0.3px; }
  .rubric-score-desc { font-size: 10px; color: var(--text-faint); line-height: 1.5;
    display: block; text-align: left; }
  .rubric-total { display: flex; align-items: center; gap: 14px; padding: 14px 18px;
    background: var(--surface2); border-radius: 8px; margin-top: 20px; }
  .rubric-total-label { font-size: 12px; font-weight: 700; color: var(--text-dim);
    letter-spacing: 0.5px; text-transform: uppercase; }
  .rubric-total-score { font-size: 28px; font-weight: 700; color: var(--green-light); }
  .rubric-total-max { font-size: 14px; color: var(--text-faint); }

  /* Files section */
  .files-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
    padding: 20px 24px; margin-bottom: 20px; }
  .files-title { font-size: 11px; font-weight: 700; letter-spacing: 1.2px;
    text-transform: uppercase; color: var(--text-dim); margin-bottom: 14px; }
  .files-row { display: flex; gap: 10px; }

  /* Reviewer row */
  .reviewer-row { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 14px 20px; margin-bottom: 10px; display: flex;
    justify-content: space-between; align-items: center; }
  .reviewer-row-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .reviewer-row-pw { font-size: 11px; color: var(--text-faint); margin-top: 3px; font-weight: 600; }
  .reviewer-row-count { font-size: 11px; color: var(--text-faint); font-weight: 700; }

  /* Misc */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }
  .form-actions { display: flex; gap: 10px; margin-top: 4px; }
  .divider { height: 1px; background: var(--border); margin: 24px 0; }
  .empty-state { text-align: center; padding: 60px 0; color: var(--text-faint); }
  .empty-icon { font-size: 32px; margin-bottom: 14px; opacity: 0.3; }
  .empty-text { font-size: 13px; }
  .save-confirm { display: flex; align-items: center; gap: 6px; font-size: 13px;
    color: var(--green-light); font-weight: 700; }
  .row-actions-header { display: flex; justify-content: space-between;
    align-items: center; margin-bottom: 22px; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
    z-index: 1000; align-items: center; justify-content: center; padding: 24px; }
  .modal-overlay.open { display: flex; }
  .modal-box { background: var(--surface); border: 1px solid var(--border2); border-radius: 14px;
    width: 100%; max-width: 860px; height: 88vh; display: flex; flex-direction: column;
    box-shadow: 0 40px 80px rgba(0,0,0,.8); overflow: hidden; }
  .modal-header { display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .modal-title { font-size: 13px; color: var(--text-dim); font-weight: 700; letter-spacing: .5px; }
  .modal-close { background: none; border: 1px solid var(--border2); border-radius: 6px;
    color: var(--text-dim); padding: 5px 12px; font-size: 12px; cursor: pointer;
    font-weight: 700; transition: all .15s; }
  .modal-close:hover { border-color: var(--green); color: var(--green-light); }
  .modal-body { flex: 1; overflow: hidden; }
  .modal-body iframe { width: 100%; height: 100%; border: none; background: #fff; }

  @media (max-width: 640px) {
    .form-grid { grid-template-columns: 1fr; }
    .login-box { width: 95vw; padding: 36px 24px; }
    .reviewer-main { padding: 20px 16px; }
    .sidebar { width: 180px; }
    .rubric-options { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>

<!-- BRYC Logo Bug -->
<div class="logo-bug">
  <img src="https://raw.githubusercontent.com/thebryc/psmhf/main/bryc-logo.png"
       onerror="this.style.display='none';this.parentElement.style.background='#0e5640';this.parentElement.innerHTML='<span style=\'color:#acd572;font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;height:100%\'>B</span>'"
       alt="BRYC">
</div>

<div id="app">

  <!-- LOADING -->
  <div id="loading-screen" class="screen">
    <div class="loading-inner">
      <div class="loading-spinner">*</div>
      <div class="loading-msg" id="loading-msg">Loading...</div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login-screen" class="screen active">
    <div class="login-box">
      <div class="login-logo-wrap">
        <img src="https://raw.githubusercontent.com/thebryc/psmhf/main/bryc-logo.png"
             onerror="this.style.display='none'"
             alt="BRYC" style="width:60px;height:60px;border-radius:50%">
      </div>
      <div class="login-title">
        <h1>Patricia Saidu Memorial<br>Health Fellows Scholarship</h1>
        <p>Baton Rouge Youth Coalition - Review Portal</p>
      </div>
      <div class="field-group">
        <label class="field-label">Your Name</label>
        <select id="login-select" class="field-input">
          <option value="">- Select your name -</option>
        </select>
      </div>
      <div class="field-group">
        <label class="field-label">Password</label>
        <input type="password" id="login-pw" class="field-input" placeholder="Enter your password">
        <div id="login-error" style="color:var(--red);font-size:12px;margin-top:6px;font-weight:600;display:none"></div>
      </div>
      <button class="btn-primary" style="width:100%;padding:13px;" onclick="doLogin()">Sign In</button>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="admin-screen" class="screen">
    <div class="app-header">
      <div class="header-left">
        <div class="header-title">Patricia Saidu Memorial &middot; <span style="color:var(--text-faint);font-size:11px;font-weight:700;letter-spacing:0.5px">ADMIN</span></div>
        <nav class="header-nav">
          <button class="nav-btn active" onclick="showTab('applicants')">Applicants</button>
          <button class="nav-btn" onclick="showTab('results')">Results</button>
          <button class="nav-btn" onclick="showTab('reviewers')">Reviewers</button>
        </nav>
      </div>
      <div class="header-right">
        <button class="btn-outline" onclick="logout()">Sign Out</button>
      </div>
    </div>

    <!-- APPLICANTS TAB -->
    <div id="tab-applicants" class="main-content">
      <div class="row-actions-header">
        <h2 class="page-title" style="margin:0">Applicants <span id="applicant-count" style="font-size:14px;color:var(--text-faint);font-weight:400"></span></h2>
      </div>
      <div id="applicant-list"></div>
    </div>

    <!-- RESULTS TAB -->
    <div id="tab-results" class="main-content" style="display:none">
      <h2 class="page-title">Review Results</h2>
      <div id="results-list"></div>
    </div>

    <!-- REVIEWERS TAB -->
    <div id="tab-reviewers" class="main-content" style="display:none">
      <h2 class="page-title">Manage Reviewers</h2>
      <p class="page-subtitle">Share each person's name and password with them privately before the review period begins.</p>
      <div id="reviewer-list"></div>
      <div class="divider"></div>
      <div class="card">
        <div class="card-title">Add Reviewer</div>
        <div class="form-grid">
          <div class="field-group">
            <label class="field-label">Name</label>
            <input class="field-input" id="new-rv-name" placeholder="Committee member name">
          </div>
          <div class="field-group">
            <label class="field-label">Password</label>
            <input class="field-input" id="new-rv-pw" placeholder="Assign a password">
          </div>
        </div>
        <button class="btn-primary" onclick="addReviewer()">Add Reviewer</button>
      </div>
    </div>
  </div>

  <!-- REVIEWER -->
  <div id="reviewer-screen" class="screen">
    <div class="app-header">
      <div class="header-left">
        <div class="header-title">Patricia Saidu Memorial Scholarship</div>
        <div class="header-user" id="rv-user-name"></div>
      </div>
      <div class="header-right">
        <span class="progress-text" id="rv-progress"></span>
        <button class="btn-outline" onclick="logout()">Sign Out</button>
      </div>
    </div>
    <div class="reviewer-layout">
      <div class="sidebar" id="rv-sidebar"></div>
      <div class="reviewer-main" id="rv-main">
        <div class="reviewer-empty">
          <div class="reviewer-empty-icon">*</div>
          <p style="font-size:13px">Select an applicant from the sidebar to begin</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FILE VIEWER MODAL -->
  <div id="file-modal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-box">
      <div class="modal-header">
        <span class="modal-title" id="modal-title"></span>
        <button class="modal-close" onclick="document.getElementById('file-modal').classList.remove('open')">Close</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

</div>

<script>
// -- Configuration --
const API_URL = (function() {
  const hardcoded = 'https://script.google.com/macros/s/AKfycbxji1xSEk2N63raK0ARvQJD2m-jGkVQzN50DGp8nJCLhu15ZmvEObp5HEZOy2x5FBim/exec';
  const loc = window.location.href;
  if (loc.includes('script.google.com/macros')) return loc.split('?')[0];
  return hardcoded;
})();

// -- State --
const STATE = {
  currentUser: null,
  applicants: [],
  reviews: {},
  reviewers: [],
  currentTab: 'applicants',
  selectedApplicant: null,
};

// -- Group logic --
const CURRENT_YEAR = new Date().getFullYear();

function getGroup(a) {
  const hasCollege = a.collegeGradYear && String(a.collegeGradYear).trim() !== '';
  if (!hasCollege) return 'hs';
  const yr = parseInt(a.collegeGradYear);
  if (isNaN(yr)) return 'hs';
  return yr > CURRENT_YEAR ? 'college' : 'alumni';
}

const GROUP_LABELS = { hs: 'High School', college: 'College Fellows', alumni: 'Alumni' };
const GROUP_ORDER  = ['hs', 'college', 'alumni'];
const GROUP_WINNERS = { hs: 3, college: 4, alumni: 3 };
const GROUP_BADGE  = { hs: 'badge-hs', college: 'badge-college', alumni: 'badge-alumni' };

function groupedApplicants() {
  const groups = { hs: [], college: [], alumni: [] };
  STATE.applicants.forEach(a => groups[getGroup(a)].push(a));
  return groups;
}

// -- Rubric definition --
const RUBRIC = [
  {
    id: 'interest',
    name: 'Interest',
    question: 'Does the applicant discuss extracurricular, research, volunteer, internship, work, personal, or other experiences that prompted their interest in healthcare?',
    levels: [
      { score: 3, title: 'Exceptional', desc: 'Describes experiences with details that demonstrate strong healthcare interest; substantive connections are made between the applicant and their experiences.' },
      { score: 2, title: 'Proficient',  desc: 'Describes experiences with effective detail and interest; the response demonstrates a connection between the applicant and their experiences.' },
      { score: 1, title: 'Developing',  desc: 'The response indicates limited interest in or connection to the applicant\'s experiences.' },
      { score: 0, title: 'Insufficient',desc: 'Response fails to demonstrate the applicant\'s interest in/connection to healthcare aspirations.' },
    ]
  },
  {
    id: 'engagement',
    name: 'Engagement',
    question: 'Does the applicant discuss their role in or contribution to the experiences discussed?',
    levels: [
      { score: 3, title: 'Exceptional', desc: 'Applicant provides substantive examples of their role in/contribution to experiences related to their intended career.' },
      { score: 2, title: 'Proficient',  desc: 'Applicant provides effective examples of their role in/contribution to career-related experiences.' },
      { score: 1, title: 'Developing',  desc: 'Applicant provides limited examples of role or contributions.' },
      { score: 0, title: 'Insufficient',desc: 'Fails to provide examples of applicant\'s role/contributions.' },
    ]
  },
  {
    id: 'purpose',
    name: 'Purpose',
    question: 'Does the applicant provide evidence of professional goals, and the skills to achieve them?',
    levels: [
      { score: 3, title: 'Exceptional', desc: 'Applicant demonstrates a clear understanding of their professional goals, and provides specific examples of skills, strengths, and/or personal qualities needed to achieve goals.' },
      { score: 2, title: 'Proficient',  desc: 'Identifies goals; provides adequate examples of the skills, strengths, and/or personal qualities needed to achieve goals.' },
      { score: 1, title: 'Developing',  desc: 'Identifies and explains goals.' },
      { score: 0, title: 'Insufficient',desc: 'Fails to identify or explain goals.' },
    ]
  },
  {
    id: 'writing',
    name: 'Writing Mechanics',
    question: 'Is the response free of grammatical, spelling, and punctuation errors?',
    levels: [
      { score: 3, title: 'Exceptional', desc: 'Response appears free of grammar, punctuation and spelling errors; demonstrates a good control of language.' },
      { score: 2, title: 'Proficient',  desc: 'Response is mainly free of spelling, punctuation and grammatical errors.' },
      { score: 1, title: 'Developing',  desc: 'Response contains some errors but they do not impede understanding.' },
      { score: 0, title: 'Insufficient',desc: 'Response contains mechanical errors that impede understanding of the content.' },
    ]
  },
];

// -- Current rubric scores (while reviewing) --
let currentRubricScores = {};

function rubricTotal() {
  return RUBRIC.reduce((sum, cat) => {
    const v = currentRubricScores[cat.id];
    return sum + (v !== undefined ? v : 0);
  }, 0);
}

function rubricComplete() {
  return RUBRIC.every(cat => currentRubricScores[cat.id] !== undefined);
}

// -- API --
async function apiGet(action) {
  const res = await fetch(API_URL + '?action=' + action);
  return res.json();
}

async function apiPost(body) {
  const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
  return res.json();
}

// -- Loading --
function showLoading(msg) {
  document.getElementById('loading-msg').textContent = msg || 'Loading...';
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('loading-screen').classList.add('active');
}
function hideLoading() {
  document.getElementById('loading-screen').classList.remove('active');
}

// -- Login --
function populateLoginSelect() {
  const sel = document.getElementById('login-select');
  sel.innerHTML = '<option value="">- Select your name -</option>';
  STATE.reviewers.forEach(r => {
    sel.innerHTML += '<option value="' + r.id + '">' + r.name + '</option>';
  });
}

function doLogin() {
  const selId = document.getElementById('login-select').value;
  const pw    = document.getElementById('login-pw').value;
  const err   = document.getElementById('login-error');
  const user  = STATE.reviewers.find(r => r.id === selId);
  if (user && user.password === pw) {
    STATE.currentUser = user;
    err.style.display = 'none';
    document.getElementById('login-screen').classList.remove('active');
    if (user.role === 'admin') {
      document.getElementById('admin-screen').classList.add('active');
      showTab('applicants');
    } else {
      document.getElementById('reviewer-screen').classList.add('active');
      document.getElementById('rv-user-name').textContent = user.name;
      renderReviewerSidebar();
      renderReviewerMain(null);
    }
  } else {
    err.textContent = 'Incorrect password. Try again.';
    err.style.display = 'block';
  }
}

document.getElementById('login-pw').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doLogin();
});

function logout() {
  STATE.currentUser = null;
  STATE.selectedApplicant = null;
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('login-screen').classList.add('active');
  document.getElementById('login-pw').value = '';
  document.getElementById('login-error').style.display = 'none';
}

// -- Admin tabs --
function showTab(tab) {
  STATE.currentTab = tab;
  document.querySelectorAll('.nav-btn').forEach(function(btn, i) {
    btn.classList.toggle('active', ['applicants','results','reviewers'][i] === tab);
  });
  document.getElementById('tab-applicants').style.display = tab === 'applicants' ? 'block' : 'none';
  document.getElementById('tab-results').style.display    = tab === 'results'    ? 'block' : 'none';
  document.getElementById('tab-reviewers').style.display  = tab === 'reviewers'  ? 'block' : 'none';
  if (tab === 'applicants') renderApplicantList();
  if (tab === 'results')    renderResults();
  if (tab === 'reviewers')  renderReviewerList();
}

// -- Score helpers --
function getReviewScores(reviewerId, applicantId) {
  const key = reviewerId + ':' + applicantId;
  return STATE.reviews[key] || null;
}

function totalScore(reviewData) {
  if (!reviewData || !reviewData.rubric) return 0;
  return Object.values(reviewData.rubric).reduce(function(s, v) { return s + v; }, 0);
}

function avgScoreForApplicant(applicantId) {
  const reviewers = STATE.reviewers.filter(function(r) { return r.role === 'reviewer'; });
  let total = 0, count = 0;
  reviewers.forEach(function(r) {
    const d = getReviewScores(r.id, applicantId);
    if (d && d.rubric && Object.keys(d.rubric).length === RUBRIC.length) {
      total += totalScore(d);
      count++;
    }
  });
  return count > 0 ? { avg: total / count, count: count } : null;
}

// -- Applicant list (admin) --
function renderApplicantList() {
  const el     = document.getElementById('applicant-list');
  const groups = groupedApplicants();
  document.getElementById('applicant-count').textContent = '(' + STATE.applicants.length + ')';

  if (STATE.applicants.length === 0) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">*</div><div class="empty-text">No applicants loaded.</div></div>';
    return;
  }

  el.innerHTML = GROUP_ORDER.map(function(gk) {
    const list = groups[gk];
    if (!list.length) return '';
    return '<div class="group-section">' +
      '<div class="group-header">' +
        '<span class="group-label">' + GROUP_LABELS[gk] + '</span>' +
        '<span class="group-count">' + list.length + ' applicants</span>' +
      '</div>' +
      list.map(function(a) {
        const sc   = avgScoreForApplicant(a.id);
        const meta = [a.school, a.collegeName, a.major].filter(Boolean).join(' - ');
        return '<div class="applicant-row">' +
          '<div class="applicant-row-top">' +
            '<div>' +
              '<div class="applicant-id">' + a.brycId + '</div>' +
              '<div class="applicant-meta">' + (meta || '-') + '</div>' +
            '</div>' +
            '<div class="applicant-actions">' +
              (sc ? '<span class="avg-badge">avg ' + sc.avg.toFixed(1) + '/12 (' + sc.count + ')</span>' : '') +
            '</div>' +
          '</div>' +
          ((!a.photoUrl || !a.resumeUrl) ?
            '<div class="link-inputs">' +
              (!a.photoUrl ? '<div class="link-input-wrap"><input class="field-input" style="font-size:11px;padding:7px 10px" placeholder="Paste photo Drive link - press Enter" onblur="saveLink(\'' + a.brycId + '\',\'photoUrl\',this)" onkeydown="if(event.key===\'Enter\')saveLink(\'' + a.brycId + '\',\'photoUrl\',this)"></div>' : '') +
              (!a.resumeUrl ? '<div class="link-input-wrap"><input class="field-input" style="font-size:11px;padding:7px 10px" placeholder="Paste resume Drive link - press Enter" onblur="saveLink(\'' + a.brycId + '\',\'resumeUrl\',this)" onkeydown="if(event.key===\'Enter\')saveLink(\'' + a.brycId + '\',\'resumeUrl\',this)"></div>' : '') +
            '</div>' : '') +
          ((a.photoUrl || a.resumeUrl) ?
            '<div class="link-badges">' +
              (a.photoUrl  ? '<button onclick="openFile(\'' + a.photoUrl  + '\',\'' + a.brycId + ' - Photo\')" class="link-badge" style="border:none;cursor:pointer">Photo</button>' : '') +
              (a.resumeUrl ? '<button onclick="openFile(\'' + a.resumeUrl + '\',\'' + a.brycId + ' - Resume\')" class="link-badge" style="border:none;cursor:pointer">Resume</button>' : '') +
            '</div>' : '') +
        '</div>';
      }).join('') +
    '</div>';
  }).join('');
}

async function saveLink(brycId, field, inputEl) {
  const val = inputEl.value.trim();
  if (!val) return;
  inputEl.disabled = true;
  inputEl.value = 'Saving...';
  const a = STATE.applicants.find(function(a) { return a.brycId === brycId; });
  if (a) a[field] = val;
  await apiPost({ action: 'saveLink', brycId: brycId, field: field, value: val });
  renderApplicantList();
}

// -- Results (admin) --
function renderResults() {
  const el     = document.getElementById('results-list');
  const groups = groupedApplicants();

  el.innerHTML = GROUP_ORDER.map(function(gk) {
    const list    = groups[gk];
    const winners = GROUP_WINNERS[gk];
    if (!list.length) return '';

    const scored = list.map(function(a) {
      const sc = avgScoreForApplicant(a.id);
      return Object.assign({}, a, { avg: sc ? sc.avg : 0, cnt: sc ? sc.count : 0 });
    }).sort(function(a, b) { return b.avg - a.avg; });

    return '<div class="winner-section">' +
      '<div class="winner-header">' +
        '<span class="winner-label">' + GROUP_LABELS[gk] + '</span>' +
        '<span class="winner-sublabel">Top ' + winners + ' selected</span>' +
      '</div>' +
      scored.map(function(a, rank) {
        const isWinner = rank < winners && a.cnt > 0;
        const rvScores = STATE.reviewers.filter(function(r) { return r.role === 'reviewer'; })
          .map(function(r) {
            const d = getReviewScores(r.id, a.id);
            return { name: r.name, data: d };
          });

        return '<div class="result-card' + (isWinner ? ' winner' : '') + '">' +
          '<div class="result-header">' +
            '<div>' +
              '<div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">' +
                '<span class="result-rank">' + (isWinner ? '#' + (rank+1) + ' WINNER' : '#' + (rank+1)) + '</span>' +
                '<span style="font-size:17px;font-weight:700">' + a.brycId + '</span>' +
              '</div>' +
              '<div style="font-size:12px;color:var(--text-faint)">' + [a.school,a.collegeName,a.major].filter(Boolean).join(' - ') + '</div>' +
            '</div>' +
            (a.cnt > 0 ? '<div style="text-align:right"><div class="result-avg">' + a.avg.toFixed(1) + '</div><div class="result-avg-label">avg / 12 pts &nbsp; ' + a.cnt + ' review' + (a.cnt !== 1 ? 's' : '') + '</div></div>' : '<div style="font-size:11px;color:var(--text-faint)">No reviews yet</div>') +
          '</div>' +
          rvScores.map(function(rv) {
            if (!rv.data || !rv.data.rubric) {
              return '<div class="reviewer-score"><div class="reviewer-score-top"><span class="reviewer-name">' + rv.name + '</span><span class="not-reviewed">Not yet reviewed</span></div></div>';
            }
            const t = totalScore(rv.data);
            const pills = RUBRIC.map(function(cat) {
              const s = rv.data.rubric[cat.id];
              return '<span class="score-pill">' + cat.name.split(' ')[0] + ': ' + (s !== undefined ? s : '-') + '</span>';
            }).join('');
            return '<div class="reviewer-score">' +
              '<div class="reviewer-score-top">' +
                '<span class="reviewer-name">' + rv.name + '</span>' +
                '<span style="font-size:13px;font-weight:700;color:var(--green-light)">' + t + '/12</span>' +
              '</div>' +
              '<div class="score-breakdown" style="margin:6px 0">' + pills + '</div>' +
              (rv.data.comment ? '<div class="reviewer-comment">' + escHtml(rv.data.comment) + '</div>' : '') +
            '</div>';
          }).join('') +
        '</div>';
      }).join('') +
    '</div>';
  }).join('');
}

// -- Reviewer management --
function renderReviewerList() {
  const el = document.getElementById('reviewer-list');
  el.innerHTML = STATE.reviewers.filter(function(r) { return r.role === 'reviewer'; }).map(function(r) {
    const done = STATE.applicants.filter(function(a) {
      const d = getReviewScores(r.id, a.id);
      return d && d.rubric && Object.keys(d.rubric).length === RUBRIC.length;
    }).length;
    return '<div class="reviewer-row">' +
      '<div><div class="reviewer-row-name">' + r.name + '</div><div class="reviewer-row-pw">Password: ' + r.password + '</div></div>' +
      '<span class="reviewer-row-count">' + done + '/' + STATE.applicants.length + ' reviewed</span>' +
    '</div>';
  }).join('');
}

async function addReviewer() {
  const name = document.getElementById('new-rv-name').value.trim();
  const pw   = document.getElementById('new-rv-pw').value.trim();
  if (!name || !pw) return;
  STATE.reviewers.push({ id: 'rv_' + Date.now(), name: name, password: pw, role: 'reviewer' });
  await apiPost({ action: 'saveReviewers', reviewers: STATE.reviewers });
  document.getElementById('new-rv-name').value = '';
  document.getElementById('new-rv-pw').value = '';
  populateLoginSelect();
  renderReviewerList();
}

// -- Reviewer sidebar --
function renderReviewerSidebar() {
  const el     = document.getElementById('rv-sidebar');
  const u      = STATE.currentUser;
  const groups = groupedApplicants();

  if (STATE.applicants.length === 0) {
    el.innerHTML = '<p style="color:var(--text-faint);font-size:11px;padding:16px">No applicants loaded.</p>';
    return;
  }

  let num = 0;
  el.innerHTML = GROUP_ORDER.map(function(gk) {
    const list = groups[gk];
    if (!list.length) return '';
    return '<div class="sidebar-group-label">' + GROUP_LABELS[gk] + '</div>' +
      list.map(function(a) {
        num++;
        const d        = getReviewScores(u.id, a.id);
        const reviewed = d && d.rubric && Object.keys(d.rubric).length === RUBRIC.length;
        const active   = STATE.selectedApplicant && STATE.selectedApplicant.id === a.id;
        const n        = num;
        return '<button class="sidebar-item' + (active ? ' active' : '') + '" onclick="selectApplicant(\'' + a.id + '\')">' +
          '<div class="sidebar-num' + (reviewed ? ' done' : '') + '">' + (reviewed ? 'v' : n) + '</div>' +
          '<span class="sidebar-label">' + a.brycId + '</span>' +
        '</button>';
      }).join('');
  }).join('');

  const total = STATE.applicants.length;
  const done  = STATE.applicants.filter(function(a) {
    const d = getReviewScores(u.id, a.id);
    return d && d.rubric && Object.keys(d.rubric).length === RUBRIC.length;
  }).length;
  document.getElementById('rv-progress').textContent = done + '/' + total + ' reviewed';
}

function selectApplicant(id) {
  const a = STATE.applicants.find(function(a) { return a.id === id; });
  if (!a) return;
  STATE.selectedApplicant = a;
  const ex = getReviewScores(STATE.currentUser.id, a.id);
  currentRubricScores = (ex && ex.rubric) ? Object.assign({}, ex.rubric) : {};
  renderReviewerSidebar();
  renderReviewerMain(a, ex);
}

function renderReviewerMain(a, ex) {
  const el = document.getElementById('rv-main');
  if (!a) {
    el.innerHTML = '<div class="reviewer-empty"><div class="reviewer-empty-icon">*</div><p style="font-size:13px">Select an applicant from the sidebar to begin</p></div>';
    return;
  }

  const group = getGroup(a);
  const tags  = [
    a.school     ? 'High School: ' + a.school + (a.gradYear ? ' (' + a.gradYear + ')' : '')           : null,
    a.collegeName ? 'College: ' + a.collegeName + (a.collegeGradYear ? ' (' + a.collegeGradYear + ')' : '') : null,
    a.major      ? 'Major: ' + a.major : null,
    a.medSchool  ? 'Med School: ' + a.medSchool : null,
    a.careerPath ? 'Career: ' + a.careerPath : null,
  ].filter(Boolean);

  const rubricHTML = RUBRIC.map(function(cat) {
    return '<div class="rubric-category">' +
      '<div class="rubric-cat-name">' + cat.name + '</div>' +
      '<div class="rubric-cat-desc">' + cat.question + '</div>' +
      '<div class="rubric-options">' +
        cat.levels.map(function(lv) {
          const checked = currentRubricScores[cat.id] === lv.score ? ' checked' : '';
          return '<div class="rubric-option">' +
            '<input type="radio" name="rubric-' + cat.id + '" id="rubric-' + cat.id + '-' + lv.score + '" value="' + lv.score + '"' + checked + ' onchange="setRubricScore(\'' + cat.id + '\',' + lv.score + ')">' +
            '<label for="rubric-' + cat.id + '-' + lv.score + '">' +
              '<span class="rubric-score-num">' + lv.score + '</span>' +
              '<span class="rubric-score-title">' + lv.title + '</span>' +
              '<span class="rubric-score-desc">' + lv.desc + '</span>' +
            '</label>' +
          '</div>';
        }).join('') +
      '</div>' +
    '</div>';
  }).join('');

  const total    = rubricTotal();
  const complete = rubricComplete();

  el.innerHTML =
    '<div style="max-width:760px">' +
      '<div class="profile-card">' +
        '<div class="profile-top">' +
          '<div>' +
            '<div class="profile-id">' + a.brycId + '</div>' +
            '<div class="profile-group-badge ' + GROUP_BADGE[group] + '">' + GROUP_LABELS[group] + '</div>' +
            '<div class="profile-tags">' + tags.map(function(t) { return '<span class="profile-tag">' + t + '</span>'; }).join('') + '</div>' +
          '</div>' +
        '</div>' +
      '</div>' +

      '<div class="essay-card">' +
        '<div class="card-title">Career Aspirations Essay</div>' +
        '<div class="essay-text">' + escHtml(a.essay || '(No essay provided)') + '</div>' +
      '</div>' +

      '<div class="scoring-card">' +
        '<div class="scoring-title">Scoring Rubric</div>' +
        '<div class="scoring-prompt">Prompt: Describe your career aspirations, including how you became interested in this career; what you have done and plan to do to prepare yourself; and what you hope to accomplish in your chosen field (500 words max).</div>' +
        rubricHTML +
        '<div class="rubric-total">' +
          '<div class="rubric-total-label">Total Score</div>' +
          '<div id="rubric-total-display"><span class="rubric-total-score" id="rubric-total-num">' + total + '</span><span class="rubric-total-max"> / 12</span></div>' +
        '</div>' +
        '<div class="field-group" style="margin-top:20px">' +
          '<label class="field-label">Additional Comments (optional)</label>' +
          '<textarea class="field-input" id="rv-comment" rows="3" placeholder="Notes for the committee...">' + escHtml(ex && ex.comment ? ex.comment : '') + '</textarea>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:14px;margin-top:4px">' +
          '<button class="btn-primary" id="save-review-btn" onclick="saveReview()" ' + (complete ? '' : 'disabled') + '>Save Review</button>' +
          '<div id="rv-saved" class="save-confirm" style="display:none">Saved!</div>' +
        '</div>' +
      '</div>' +

      '<div class="files-card">' +
        '<div class="files-title">Supporting Documents</div>' +
        '<div class="files-row">' +
          (a.photoUrl  ? '<button onclick="openFile(\'' + a.photoUrl  + '\',\'' + a.brycId + ' - Photo\')"  class="link-badge" style="border:none;cursor:pointer">View Photo</button>'  : '<span style="font-size:12px;color:var(--text-faint)">No photo uploaded</span>') +
          (a.resumeUrl ? '<button onclick="openFile(\'' + a.resumeUrl + '\',\'' + a.brycId + ' - Resume\')" class="link-badge" style="border:none;cursor:pointer">View Resume</button>' : '') +
        '</div>' +
      '</div>' +
    '</div>';
}

function setRubricScore(catId, score) {
  currentRubricScores[catId] = score;
  const total    = rubricTotal();
  const complete = rubricComplete();
  const numEl    = document.getElementById('rubric-total-num');
  const btn      = document.getElementById('save-review-btn');
  if (numEl) numEl.textContent = total;
  if (btn)   btn.disabled = !complete;
}

async function saveReview() {
  const a = STATE.selectedApplicant;
  if (!a || !rubricComplete()) return;
  const btn = document.getElementById('save-review-btn');
  btn.textContent = 'Saving...';
  btn.disabled = true;
  const comment = document.getElementById('rv-comment').value;
  const key     = STATE.currentUser.id + ':' + a.id;
  STATE.reviews[key] = { rubric: Object.assign({}, currentRubricScores), comment: comment };
  await apiPost({
    action:     'saveReview',
    reviewerId:  STATE.currentUser.id,
    applicantId: a.id,
    rubric:      currentRubricScores,
    score:       rubricTotal(),
    comment:     comment,
  });
  btn.textContent = 'Save Review';
  btn.disabled = false;
  const saved = document.getElementById('rv-saved');
  if (saved) { saved.style.display = 'flex'; setTimeout(function() { saved.style.display = 'none'; }, 2500); }
  renderReviewerSidebar();
}

// -- File viewer modal --
function driveEmbedUrl(url) {
  var id = null;
  var m1 = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  var m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if (m1) id = m1[1];
  else if (m2) id = m2[1];
  if (!id) return url;
  return 'https://drive.google.com/file/d/' + id + '/preview';
}

function openFile(url, label) {
  document.getElementById('modal-title').textContent = label;
  document.getElementById('modal-body').innerHTML = '<iframe src="' + driveEmbedUrl(url) + '" allowfullscreen></iframe>';
  document.getElementById('file-modal').classList.add('open');
}

function closeModal(e) {
  if (e.target === document.getElementById('file-modal'))
    document.getElementById('file-modal').classList.remove('open');
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// -- Init --
async function init() {
  showLoading('Loading applicants...');
  try {
    const data = await apiGet('getAll');
    if (data.error) throw new Error(data.error);
    STATE.applicants = data.applicants || [];
    STATE.reviewers  = data.reviewers  || [];

    // Migrate old score-based reviews to rubric format
    const raw = data.reviews || {};
    STATE.reviews = {};
    Object.keys(raw).forEach(function(k) {
      const v = raw[k];
      if (v && typeof v === 'object' && v.rubric) {
        STATE.reviews[k] = v;
      } else if (v && typeof v === 'object' && v.score !== undefined) {
        // Old format: convert single score to rubric (best effort)
        STATE.reviews[k] = { rubric: {}, comment: v.comment || '', legacy: true };
      }
    });

    populateLoginSelect();
    hideLoading();
    document.getElementById('login-screen').classList.add('active');
  } catch(e) {
    hideLoading();
    document.getElementById('login-screen').classList.add('active');
    document.getElementById('login-error').textContent = 'Could not connect: ' + e.message;
    document.getElementById('login-error').style.display = 'block';
  }
}

init();
</script>
</body>
</html>
